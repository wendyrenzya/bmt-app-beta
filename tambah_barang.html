<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Tambah Barang</title>
<style>
body{margin:0;background:#fff;font-family:Inter,Roboto;color:#222}*{-webkit-tap-highlight-color:transparent}
.header{background:linear-gradient(135deg,#3E8BFF,#A259FF);color:#fff;padding:16px 18px;display:flex;align-items:center;gap:14px;font-size:18px;font-weight:700;position:sticky;top:0;z-index:20}
.container{padding:18px}.form-card{background:#fff;border-radius:14px;border:1px solid #eee;box-shadow:0 2px 8px rgba(0,0,0,0.06);padding:18px;display:flex;flex-direction:column;gap:14px}.label{font-size:14px;font-weight:600;color:#444;margin-bottom:4px}.input,select,textarea{width:100%;padding:12px;border-radius:12px;border:1px solid #ccc;font-size:14px;box-sizing:border-box}textarea{resize:none;height:90px}.more-toggle{width:100%;text-align:center;padding:10px 0;cursor:pointer;color:#3E8BFF;font-weight:700;font-size:14px;display:flex;gap:6px;align-items:center;justify-content:center;margin-top:4px}.more-wrap{overflow:hidden;transition:max-height .35s ease;max-height:0}.preview-img{width:130px;height:130px;border-radius:14px;background:#e5e5e5;object-fit:cover;margin-top:5px}.footer-btns{position:fixed;bottom:0;left:0;right:0;background:#fff;border-top:1px solid #eee;display:flex;gap:12px;padding:14px}.btn{flex:1;padding:14px 0;border-radius:12px;text-align:center;font-size:15px;font-weight:700;cursor:pointer}.btn-outline{border:2px solid #888;color:#555}.btn-primary{background:#3E8BFF;color:#fff}.bounce{animation:bounce .25s ease-out}@keyframes bounce{0%{transform:scale(1)}40%{transform:scale(.92)}100%{transform:scale(1)}}
</style>
</head>
<body>

<div class="header">
  <img src="assets/back_white.png" id="btnBack" style="width:22px;height:22px;cursor:pointer"> Tambah Barang
</div>

<div class="container">
  <div class="form-card">
    <div>
      <div class="label">Nama Barang *</div>
      <input id="nama" class="input">
    </div>

    <div>
      <div class="label">Kode Barang (otomatis)</div>
      <input id="kode" class="input" readonly>
    </div>

    <div>
      <div class="label">Kategori *</div>
      <div style="display:flex;gap:8px;align-items:center;">
        <input id="kategoriDisplay" class="input" readonly placeholder="Pilih kategori" style="flex:1;cursor:pointer;">
        <button id="openCat" style="padding:10px 12px;border-radius:10px;border:1px solid #ddd;background:#fff;cursor:pointer">Pilih</button>
      </div>
    </div>

    <div>
      <div class="label">Harga Jual *</div>
      <input id="harga_jual" class="input" type="number">
    </div>

    <div class="more-toggle" id="toggleMore">▼ More</div>

    <div id="moreSection" class="more-wrap">
      <div style="margin-top:12px;">
        <div class="label">Harga Modal (opsional)</div>
        <input id="harga_modal" class="input" type="number">
      </div>

      <div>
        <div class="label">Deskripsi (opsional)</div>
        <textarea id="deskripsi"></textarea>
      </div>

      <div>
        <div class="label">Foto (URL opsional)</div>
        <input id="foto_url" class="input" placeholder="https://...">
        <img id="preview" class="preview-img" src="assets/no_image.png">
      </div>
    </div>
  </div>
</div>

<div class="footer-btns">
  <div class="btn btn-outline" id="btnCancel">Batal</div>
  <div class="btn btn-primary" id="btnSave">Simpan</div>
</div>

<!-- category bottom sheet -->
<div id="catSheet" class="bottom-sheet" style="display:none;">
  <div style="width:36px;height:5px;background:#e6e6e6;border-radius:999px;margin:8px auto;"></div>
  <div id="catList"></div>
</div>

<script src="app.js"></script>
<script>
let changed=false, moreOpen=false;
function markChanged(){ if(!changed){ changed=true; window.unsavedChanges=true; } }
document.querySelectorAll("input,select,textarea").forEach(el=>el.addEventListener("input", markChanged));

document.getElementById("btnBack").onclick = ()=> { if(changed && !confirm("Perubahan belum disimpan. Kembali?")) return; guardedNavigate("barang.html"); };
document.getElementById("btnCancel").onclick = ()=> { document.getElementById("btnCancel").classList.add("bounce"); setTimeout(()=>document.getElementById("btnCancel").classList.remove("bounce"),260); if(changed && !confirm("Perubahan belum disimpan. Batalkan?")) return; guardedNavigate("barang.html"); };

document.getElementById("toggleMore").onclick = ()=> { const el=document.getElementById("toggleMore"); el.classList.add("bounce"); setTimeout(()=>el.classList.remove("bounce"),250); const more=document.getElementById("moreSection"); if(!moreOpen){ more.style.maxHeight="600px"; document.getElementById("toggleMore").textContent="▲ Less"; moreOpen=true; } else { more.style.maxHeight="0px"; document.getElementById("toggleMore").textContent="▼ More"; moreOpen=false; } };

document.getElementById("foto_url").oninput = ()=> { document.getElementById("preview").src = document.getElementById("foto_url").value.trim() || "assets/no_image.png"; };

async function initForm(){
  // generate kode auto (frontend display only; final code generated server-side too)
  const generated = await generateKodeBarang();
  document.getElementById("kode").value = generated;

  // load categories for sheet
  const cats = await getKategori();
  const catList = document.getElementById("catList");
  if(!cats || cats.length===0){
    catList.innerHTML = `<div style="text-align:center;color:#888;padding:24px">Belum ada kategori di database</div>`;
  } else {
    catList.innerHTML = cats.map(c=>`<div class="category-item" data-cat="${c}" style="padding:12px;background:#fafafa;margin-bottom:8px;border-radius:10px;cursor:pointer;font-weight:700">${c}</div>`).join("");
    catList.querySelectorAll(".category-item").forEach(el=>{
      el.addEventListener("click", ()=>{
        document.getElementById("kategoriDisplay").value = el.getAttribute("data-cat");
        markChanged();
        document.getElementById("catSheet").style.display = "none";
      });
    });
  }
}
initForm();

document.getElementById("openCat").onclick = ()=> { document.getElementById("catSheet").style.display = "block"; };
document.addEventListener("click", (ev)=>{ const sheet = document.getElementById("catSheet"); if(sheet.style.display==="block" && !sheet.contains(ev.target) && ev.target.id !== "openCat" && ev.target.id !== "kategoriDisplay") sheet.style.display = "none"; });

document.getElementById("btnSave").onclick = async ()=>{
  const nama = document.getElementById("nama").value.trim();
  const kode = document.getElementById("kode").value.trim(); // shown but server will ignore and generate
  const kategori = document.getElementById("kategoriDisplay").value.trim();
  const harga_jual = Number(document.getElementById("harga_jual").value) || 0;
  const harga_modal = Number(document.getElementById("harga_modal").value) || 0;
  const deskripsi = document.getElementById("deskripsi").value.trim();
  let foto = document.getElementById("foto_url").value.trim();

  if(!nama || !kategori || !harga_jual){
    alert("Nama, Kategori, dan Harga Jual wajib diisi.");
    return;
  }

  if(!foto){
    foto = await fetchDuckImageAPI(nama) || "assets/no_image.png";
  }

  const payload = {
    // kode_barang omitted/ignored by server (server will generate numeric code)
    nama,
    kategori,
    harga: harga_jual,
    harga_modal,
    stock: 0,
    deskripsi,
    foto
  };

  const res = await addBarang(payload);
  if (res && res.ok) {
    showToast("✓ Barang berhasil disimpan");
    window.unsavedChanges = false;
    setTimeout(()=> guardedNavigate("barang.html"), 700);
  } else {
    alert("Gagal menyimpan: " + (res && res.error ? res.error : "unknown"));
  }
};
</script>
</body>
</html>
