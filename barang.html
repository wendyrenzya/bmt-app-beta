<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Barang</title>
<style>
body{margin:0;padding-bottom:90px;background:#f4f5f7;font-family:Inter,Roboto;color:#222}*{-webkit-tap-highlight-color:transparent}
.header{background:linear-gradient(135deg,#3E8BFF,#A259FF);color:#fff;padding:20px;text-align:center;font-size:18px;font-weight:700;position:sticky;top:0;z-index:30}
.fab{position:fixed;bottom:78px;right:18px;width:60px;height:60px;border-radius:50%;background:linear-gradient(135deg,#4CA3FF,#A259FF);display:flex;align-items:center;justify-content:center;box-shadow:0 4px 18px rgba(0,0,0,0.25);cursor:pointer;z-index:999}
.fab svg{width:28px;height:28px;stroke:white;stroke-width:3}
.search-row{padding:12px 14px 0 14px;display:flex;gap:12px;align-items:center}
.search-box-modern{flex:1;background:#fff;border-radius:14px;border:1px solid #e1e1e1;padding:8px 10px;display:flex;align-items:center;gap:8px;box-shadow:0 2px 6px rgba(0,0,0,0.05)}
.search-box-modern input{flex:1;border:none;outline:none;font-size:15px}
.search-icon{width:18px;height:18px;opacity:.65}
.filter-btn{width:44px;height:44px;background:#fff;border:1px solid #e1e1e1;border-radius:14px;display:flex;align-items:center;justify-content:center;cursor:pointer;box-shadow:0 2px 6px rgba(0,0,0,0.05)}
.filter-panel{display:none;padding:0 14px;margin-top:6px}
#kategoriFilter,#sortFilter{width:100%;padding:12px;border-radius:14px;border:1px solid #ddd;font-size:14px;background:#fff;margin-bottom:10px}
.list{padding:12px 14px;display:flex;flex-direction:column;gap:14px}
.item{background:#fff;border-radius:14px;padding:10px;display:flex;gap:14px;align-items:center;box-shadow:0 2px 6px rgba(0,0,0,0.08);cursor:pointer;transition:.15s}
.item img{width:64px;height:64px;object-fit:cover;border-radius:8px;background:#eee}
.item-info{flex:1}
.item-name{font-size:15px;font-weight:700;margin-bottom:4px}
.item-sub{font-size:13px;color:#666}
.navbar{position:fixed;bottom:0;left:0;right:0;background:#fff;display:flex;justify-content:space-around;padding:8px 0 6px;border-top:1px solid #e6e6e6;z-index:998}
.nav-item{display:flex;flex-direction:column;align-items:center;font-size:11px;font-weight:600;color:#6a6a6a;padding:6px 12px;border-radius:16px;cursor:pointer;transition:.15s}
.nav-item img{width:28px;height:28px;margin-bottom:4px;opacity:.65}
.nav-active{background:rgba(62,139,255,0.12);color:#3E8BFF !important}
.bottom-sheet { position: fixed; left: 0; right: 0; bottom: -100%; background: #fff; border-top-left-radius: 20px; border-top-right-radius: 20px; max-height: 60%; box-shadow: 0 -6px 30px rgba(0,0,0,0.2); transition: bottom .28s ease; z-index: 9999; padding: 12px 16px; }
.bottom-sheet.open { bottom: 0; }
.sheet-handle { width:36px;height:5px;background:#e6e6e6;border-radius:999px;margin:8px auto; }
.category-item { padding:14px 12px; font-weight:600; border-radius:12px; margin-bottom:8px; cursor:pointer; background:#fafafa; }
.category-empty { text-align:center; color:#888; padding:28px 0; }
.bounce{animation:bounceTap .25s ease-out}
@keyframes bounceTap{0%{transform:scale(1)}40%{transform:scale(.92)}100%{transform:scale(1)}}
</style>
</head>
<body>

<div class="header">Barang</div>

<div class="fab" id="fabAdd" title="Tambah Barang">
  <svg viewBox="0 0 24 24" fill="none"><path d="M12 5v14M5 12h14"/></svg>
</div>

<div class="search-row">
  <div class="search-box-modern">
    <img src="assets/search_icon.png" class="search-icon" alt="search">
    <input type="text" id="searchInput" placeholder="cari barang..">
  </div>

  <button class="filter-btn" id="filterBtn" title="Filter">
    <img src="assets/filter_icon.png" alt="filter">
  </button>
</div>

<div id="filterPanel" class="filter-panel">
  <select id="kategoriFilter">
    <option value="ALL">Semua Kategori</option>
  </select>

  <select id="sortFilter">
    <option value="DEFAULT">Urutkan: Default</option>
    <option value="NAME_ASC">Nama (A–Z)</option>
    <option value="PRICE_LOW">Harga Termurah</option>
    <option value="PRICE_HIGH">Harga Termahal</option>
    <option value="STOCK_HIGH">Stok Terbanyak</option>
  </select>
</div>

<div class="list" id="listBarang">Memuat data...</div>

<div class="navbar">
  <div class="nav-item" onclick="guardedNavigate('home.html')"><img src="assets/beranda.png">Beranda</div>
  <div class="nav-item nav-active" onclick="guardedNavigate('barang.html')"><img src="assets/barang.png">Barang</div>
  <div class="nav-item" onclick="guardedNavigate('riwayat.html')"><img src="assets/riwayat.png">Riwayat</div>
  <div class="nav-item" onclick="guardedNavigate('pengaturan.html')"><img src="assets/pengaturan.png">Pengaturan</div>
</div>

<!-- bottom sheet -->
<div id="catSheet" class="bottom-sheet">
  <div class="sheet-handle"></div>
  <div id="sheetContent"></div>
</div>

<script src="app.js"></script>
<script>
const listEl = document.getElementById("listBarang");
const searchEl = document.getElementById("searchInput");
const fab = document.getElementById("fabAdd");
const filterBtn = document.getElementById("filterBtn");
const filterPanel = document.getElementById("filterPanel");
const kategoriFilter = document.getElementById("kategoriFilter");
const sortFilter = document.getElementById("sortFilter");

const catSheet = document.getElementById("catSheet");
const sheetContent = document.getElementById("sheetContent");

fab.onclick = ()=> { fab.classList.add("bounce"); setTimeout(()=>fab.classList.remove("bounce"),260); setTimeout(()=> guardedNavigate("tambah_barang.html"),120); };
filterBtn.onclick = ()=> filterPanel.style.display = (filterPanel.style.display==="block")? "none":"block";

function openCatSheet(){ catSheet.classList.add("open"); }
function closeCatSheet(){ catSheet.classList.remove("open"); }

function levenshtein(a,b){ if(!a) return b.length; if(!b) return a.length; const m=[]; for(let i=0;i<=b.length;i++)m[i]=[i]; for(let j=0;j<=a.length;j++) m[0][j]=j; for(let i=1;i<=b.length;i++) for(let j=1;j<=a.length;j++) m[i][j]=(b[i-1]===a[j-1])?m[i-1][j-1]:Math.min(m[i-1][j]+1,m[i][j-1]+1,m[i-1][j-1]+1); return m[b.length][a.length]; }
function highlight(text, keywords){ let t=text; keywords.forEach(kw=>{ if(!kw) return; const r=new RegExp("("+kw+")","gi"); t=t.replace(r,"<span style='background:yellow;border-radius:4px;padding:0 2px;'>$1</span>"); }); return t; }
function applySorting(data){ switch(sortFilter.value){ case "NAME_ASC": return data.sort((a,b)=>a.nama.localeCompare(b.nama)); case "PRICE_LOW": return data.sort((a,b)=>(a.harga||0)-(b.harga||0)); case "PRICE_HIGH": return data.sort((a,b)=>(b.harga||0)-(a.harga||0)); case "STOCK_HIGH": return data.sort((a,b)=>(b.stock||0)-(a.stock||0)); default: return data; } }

async function renderList(filter=""){
  listEl.innerHTML = "";
  const q = filter.toLowerCase().trim();
  const keywords = q.split(/\s+/).filter(k=>k.length>0);
  const dataAll = await getBarang();
  let data = dataAll.filter(b=>{
    const t = ((b.nama||"")+" "+(b.kode_barang||"")+" "+(b.kategori||"")).toLowerCase();
    if(kategoriFilter.value !== "ALL"){
      if((b.kategori||"").toLowerCase() !== kategoriFilter.value.toLowerCase()) return false;
    }
    if(keywords.length === 0) return true;
    return keywords.every(kw=>{
      if(t.includes(kw)) return true;
      return t.split(/\s+/).some(w => levenshtein(w, kw) <= 1);
    });
  });
  data = applySorting(data);
  if(data.length === 0){ listEl.innerHTML = `<div style="text-align:center;color:#888;padding:30px 0">Tidak ada barang ditemukan</div>`; return; }
  data.forEach(b=>{
    const foto = (b.foto && b.foto.trim()!=="") ? b.foto : "assets/no_image.png";
    const div = document.createElement("div"); div.className="item";
    const namaHighlighted = highlight(b.nama, keywords);
    div.innerHTML = `<img src="${foto}" alt=""><div class="item-info"><div class="item-name">${namaHighlighted}</div><div class="item-sub">${b.kode_barang} • Stok: ${b.stock ?? 0}</div></div>`;
    div.onclick = ()=> { div.classList.add("bounce"); setTimeout(()=>div.classList.remove("bounce"),260); setTimeout(()=> guardedNavigate(`barang_detail.html?id=${b.id}`),120); };
    listEl.appendChild(div);
  });
}

searchEl.addEventListener("input", ()=> renderList(searchEl.value));

async function loadCategories(){
  const cats = await getKategori();
  if(!cats || cats.length===0){
    sheetContent.innerHTML = `<div class="category-empty">Belum ada kategori di database</div>`;
    kategoriFilter.innerHTML = `<option value="ALL">Semua Kategori</option>`;
    return;
  }
  sheetContent.innerHTML = cats.map(c=>`<div class="category-item" data-cat="${c}">${c}</div>`).join("");
  sheetContent.querySelectorAll(".category-item").forEach(el=>{
    el.addEventListener("click", ()=>{
      const cat = el.getAttribute("data-cat");
      kategoriFilter.value = cat;
      renderList(searchEl.value);
      closeCatSheet();
    });
  });
  let html = `<option value="ALL">Semua Kategori</option>`;
  cats.forEach(c=> html += `<option value="${c}">${c}</option>`);
  kategoriFilter.innerHTML = html;
}

document.addEventListener("click", (ev)=>{
  if(!catSheet.contains(ev.target) && !filterBtn.contains(ev.target)) closeCatSheet();
});

(async function init(){
  await loadCategories();
  await renderList("");
})();
</script>
</body>
</html>
